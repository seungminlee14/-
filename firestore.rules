rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 커뮤니티 글
    match /posts/{postId} {
      allow read: if true; // 모두 조회 가능
      allow create: if request.auth != null; // 로그인 후 작성
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.authorId; // 작성자만 수정/삭제

      // 댓글
      match /comments/{commentId} {
        allow read: if true;
        allow create: if request.auth != null;
      }

      // 좋아요/싫어요(사용자별 1개 문서)
      match /votes/{userId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // 글 번호 카운터 등 메타데이터
    match /meta/{docId} {
      allow read, write: if request.auth != null;
    }

    // 계정 정지
    match /bans/{email} {
      allow read: if request.auth != null;
      allow write: if request.auth != null; // 콘솔에서 관리자만 쓰도록 제어하세요.
    }

    // 정지/해제 기록
    match /banLogs/{logId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null; // 콘솔에서 관리자만 쓰도록 제어하세요.
    }

      // 사용자 디렉터리 (닉네임/프로필 검색용)
      match /userDirectory/{email} {
        allow read: if request.auth != null && (request.auth.token.email == email || request.auth.token.email == 'seungminlee14@naver.com');
      allow write: if request.auth != null && request.auth.token.email != null &&
        (request.auth.token.email == email || request.auth.token.email == 'seungminlee14@naver.com');
    }

    // 처벌 카운트
    match /punishmentCounts/{email} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.token.email == 'seungminlee14@naver.com';
    }

    // 처벌 내역
    match /punishments/{punishmentId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.token.email == 'seungminlee14@naver.com';
      allow update: if request.auth != null && (
        request.auth.token.email == 'seungminlee14@naver.com' ||
        (resource.data.emailLower != null && request.auth.token.email == resource.data.emailLower &&
          request.resource.data.diff(resource.data).changedKeys().hasOnly(['acknowledged', 'acknowledgedAt']))
      );
    }

    // 이의제기
    match /appeals/{appealId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null && request.auth.token.email == 'seungminlee14@naver.com';
    }
  }
}
